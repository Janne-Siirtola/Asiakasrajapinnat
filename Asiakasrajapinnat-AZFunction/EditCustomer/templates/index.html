<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{% if customer %}Edit Customer: {{ customer.name | upper }}{% else %}Select Customer to Edit{% endif %}</title>
  <style>
    /* ======== Reset & apuluokat ======== */
    *,
    *::before,
    *::after {
    box-sizing: border-box;
    }

    [hidden] {
    display: none !important;    /* lomake/lista piiloon yhdell√§ attribuutilla */
    }

    /* ======== Peruslayout ======== */
    body {
    font-family: Arial, sans-serif;
    background-color: #f9f9f9;
    margin: 0;
    padding: 20px;
    }

    .container {
    max-width: 700px;
    margin: 0 auto;
    background-color: #ffffff;
    padding: 20px 30px;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    h1 {
    text-align: center;
    margin: 0 0 20px;
    color: #333333;
    }

    /* ======== Asiakaslista ======== */
    ul.customer-list {
    list-style: none;
    padding: 0;
    margin: 0;
    }

    ul.customer-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding: 8px 12px;
    background-color: #f7f7f7;
    border: 1px solid #dddddd;
    border-radius: 4px;
    }

    ul.customer-list li span.name {
    font-weight: 600;
    color: #444444;
    overflow-wrap: anywhere;   /* pitk√§t nimet rikki ilman hor.‚ÄØscrollia */
    }

    ul.customer-list .edit-btn {
    border: none;
    cursor: pointer;
    outline: none;
    background-color: #0078d4;
    color: #ffffff;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 13px;
    transition: background-color .15s ease-in-out;
    }
    ul.customer-list .edit-btn:hover,
    ul.customer-list .edit-btn:focus {
    background-color: #005a9e;
    }

    /* ======== Lomakkeen kent√§t ======== */
    .form-group {
    margin-bottom: 15px;
    }
    .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #555555;
    }
    .form-group input,
    .form-group select {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid #cccccc;
    border-radius: 4px;
    font-size: 14px;
    background-color: #ffffff;
    color: #333333;
    }
    .form-group input:focus,
    .form-group select:focus {
    border-color: #0078d4;
    outline: none;
    }
    small {
    color: #666666;
    font-size: 12px;
    }

    /* ======== Fieldset + lis√§sarakkeet ======== */
    fieldset {
    border: 1px solid #cccccc;
    padding: 15px 20px 20px;
    margin: 0 0 20px;
    border-radius: 4px;
    background-color: #fafafa;
    }
    legend {
    padding: 0 8px;
    font-weight: 600;
    color: #333333;
    }

    .extra-columns-group {
    position: relative;
    margin-bottom: 12px;
    padding: 12px;
    border: 1px solid #dddddd;
    border-radius: 4px;
    background-color: #f7f7f7;
    }
    .extra-columns-group .form-group {
    margin-bottom: 8px;
    }
    .removeColumnBtn {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: #e81123;
    color: #ffffff;
    border: none;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 13px;
    cursor: pointer;
    }
    .removeColumnBtn:hover {
    background-color: #c50f1f;
    }

    /* Lis√§√§ lis√§sarake -painike */
    #addExtraColumnBtn {
    background-color: #0078d4;
    color: #ffffff;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    margin-top: 10px;
    }
    #addExtraColumnBtn:hover {
    background-color: #005a9e;
    }

    /* ======== Tallenna / Peruuta -napit ======== */
    .submit-btn {
    display: block;
    width: 100%;
    padding: 10px 0;
    font-size: 16px;
    border: none;
    border-radius: 4px;
    color: #ffffff;
    background-color: #0078d4;
    cursor: pointer;
    transition: background-color .15s ease-in-out;
    }
    .submit-btn:hover,
    .submit-btn:focus {
    background-color: #005a9e;
    }

    /* Peruuta eriv√§riseksi */
    #cancelBtn {
    background-color: #666666;
    margin-top: 10px;
    }
    #cancelBtn:hover,
    #cancelBtn:focus {
    background-color: #4d4d4d;
    }

    /* ======== Pieni fade kun n√§kym√§ vaihtuu (valinnainen) ======== */
    @media (prefers-reduced-motion: no-preference) {
    [hidden] {
        opacity: 0;
        transform: translateY(-4px);
        transition: opacity .2s ease-out, transform .2s ease-out;
    }
    :not([hidden]) {
        opacity: 1;
        transform: translateY(0);
    }
    }

  </style>
</head>
<body>
  <div class="container">

    <!-- ===========================
         2. üìù Asiakaslista
         ===========================-->
    <h1 id="listTitle">Valitse asiakas</h1>
    <ul id="customerList" class="customer-list">
      {% for cust in customers %}
        <li>
          <span class="name">{{ cust.name }}</span>
          <!--  üîÑ Linkin sijasta painike, data‚Äëattribuutissa nimi -->
          <button class="edit-btn" data-name="{{ cust.name }}">Muokkaa</button>
        </li>
      {% endfor %}
    </ul>

    <!-- ===========================
         3. ‚úèÔ∏è Muokkauslomake (piilossa)
         ===========================-->
    <form id="editForm" method="post" action="" hidden>
      <h1 id="formTitle"></h1>   <!-- t√§ytet√§√§n JS:ss√§ -->

      <!-- Kent√§t ‚Äì¬†samat kuin alkuper√§isess√§ lomakkeessa -->
      <div class="form-group">
        <label for="name">Asiakkaan nimi</label>
        <input type="text" id="name" name="name" readonly />
      </div>

      <div class="form-group">
        <label for="konserni">Konserninumerot</label>
        <input type="text" id="konserni" name="konserni" required />
        <small>Erottele pilkuilla</small>
      </div>

      <div class="form-group">
        <label for="src_container">L√§hdekontti</label>
        <input type="text" id="src_container" name="src_container" required />
      </div>

      <div class="form-group">
        <label for="dest_container">Kohdekontti</label>
        <input type="text" id="dest_container" name="dest_container" required />
      </div>

      <div class="form-group">
        <label for="file_format">Tiedostoformaatti</label>
        <select id="file_format" name="file_format" required>
          <option value="json">JSON</option>
          <option value="csv">CSV</option>
        </select>
      </div>

      <!-- ‚≠êÔ∏è Extra‚Äëcolumns‚Äëkentille luodaan oma div; t√§ytet√§√§n JS:ll√§ -->
      <fieldset>
        <legend>Lis√§sarakkeet</legend>
        <div id="extraColumnsContainer"></div>
        <button type="button" id="addExtraColumnBtn">+ Lis√§√§ sarake</button>
      </fieldset>

      <div class="form-group">
        <label for="exclude_columns">Pois perus¬≠sarakkeista</label>
        <input type="text" id="exclude_columns" name="exclude_columns" />
      </div>

      <button type="submit" class="submit-btn">Tallenna</button>
      <button type="button" id="cancelBtn" class="submit-btn" style="margin-top:8px;background:#777;">
        Peruuta
      </button>
    </form>
  </div>

  <!-- ===========================
       4. üîó Asiakasdata JSON‚Äëmuodossa
       ===========================-->
  <script id="customersData" type="application/json">
    {{ customers | tojson }}
  </script>

  <!-- ===========================
       5. üíª JavaScript
       ===========================-->
  <script>
  (function () {
    const customers = JSON.parse(
      document.getElementById("customersData").textContent
    );

    /* ---------- Elementtireferenssit ---------- */
    const listTitle   = document.getElementById("listTitle");
    const customerUl  = document.getElementById("customerList");
    const form        = document.getElementById("editForm");
    const formTitle   = document.getElementById("formTitle");
    const cancelBtn   = document.getElementById("cancelBtn");

    /* ---------- Lomakkeen kent√§t ---------- */
    const $ = id => form.querySelector("#" + id);
    const fields = {
      name: $("name"),
      konserni: $("konserni"),
      src_container: $("src_container"),
      dest_container: $("dest_container"),
      file_format: $("file_format"),
      exclude_columns: $("exclude_columns"),
      extraContainer: document.getElementById("extraColumnsContainer")
    };

    /* ---------- Sarake‚Äëtemplate ---------- */
    function makeExtraRow(key = "", info = {name:"",dtype:""}) {
      const div = document.createElement("div");
      div.className = "extra-columns-group";
      div.innerHTML = `
        <button type="button" class="removeColumnBtn">Poista</button>
        <div class="form-group"><label>Avaimen nimi</label>
          <input type="text" name="extra_key" value="${key}">
        </div>
        <div class="form-group"><label>N√§ytt√∂nimi</label>
          <input type="text" name="extra_name" value="${info.name}">
        </div>
        <div class="form-group"><label>Tietotyyppi</label>
          <input type="text" name="extra_dtype" value="${info.dtype}">
        </div>`;
      div.querySelector(".removeColumnBtn").onclick = () => div.remove();
      return div;
    }
    document
      .getElementById("addExtraColumnBtn")
      .addEventListener("click", () =>
        fields.extraContainer.appendChild(makeExtraRow())
      );

    /* ---------- N√§yt√§ muokkauslomake ---------- */
    customerUl.addEventListener("click", e => {
      const btn = e.target.closest(".edit-btn");
      if (!btn) return;

      const name = btn.dataset.name;
      const cust = customers.find(c => c.name === name);
      if (!cust) return console.error("Asiakasta ei l√∂ytynyt");

      // T√§ytet√§√§n lomake
      formTitle.textContent = `Muokkaa: ${cust.name.toUpperCase()}`;
      fields.name.value            = cust.name;
      fields.konserni.value        = cust.konserni.join(",");
      fields.src_container.value   = (cust.source_container || "").replace("/", "");
      fields.dest_container.value  = (cust.destination_container || "").replace("/", "");
      fields.file_format.value     = cust.file_format;
      fields.exclude_columns.value = (cust.exclude_columns || []).join(",");

      // Tyhjenn√§ & t√§yt√§ lis√§sarakkeet
      fields.extraContainer.innerHTML = "";
      if (cust.extra_columns) {
        for (const [k, info] of Object.entries(cust.extra_columns)) {
          fields.extraContainer.appendChild(makeExtraRow(k, info));
        }
      }

      // Vaihda n√§kym√§
      customerUl.hidden = true;
      listTitle.hidden  = true;
      form.hidden       = false;
      form.scrollIntoView({behavior:"smooth"});
    });

    /* ---------- Peruutus ---------- */
    cancelBtn.onclick = () => {
      form.hidden       = true;
      customerUl.hidden = false;
      listTitle.hidden  = false;
    };
  })();
  </script>
</body>
</html>