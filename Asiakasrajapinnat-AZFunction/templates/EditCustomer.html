<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Asiakasrajapinnat - Edit Customer</title>
  <style>


  </style>
</head>
<body>
  <div class="container">

    <!-- ===========================
         2. üìù Asiakaslista
         ===========================-->
    <h1 id="listTitle">Valitse asiakas</h1>
    <ul id="customerList" class="customer-list">
      {% for cust in customers %}
        <li>
          <span class="name">{{ cust.name }}</span>
          <!--  üîÑ Linkin sijasta painike, data‚Äëattribuutissa nimi -->
          <button class="edit-btn" data-name="{{ cust.name }}">Muokkaa</button>
        </li>
      {% endfor %}
    </ul>

    <!-- ===========================
         3. ‚úèÔ∏è Muokkauslomake (piilossa)
         ===========================-->
    <form id="editForm" method="post" action="" hidden>
      <h1 id="formTitle"></h1>   <!-- t√§ytet√§√§n JS:ss√§ -->

      <!-- Kent√§t ‚Äì¬†samat kuin alkuper√§isess√§ lomakkeessa -->
      <div class="form-group">
        <label for="name">Asiakkaan nimi</label>
        <input type="text" id="name" name="name" readonly />
      </div>

      <div class="form-group">
        <label for="konserni">Konserninumerot</label>
        <input type="text" id="konserni" name="konserni" required />
        <small>Erottele pilkuilla</small>
      </div>

      <div class="form-group">
        <label for="src_container">L√§hdekontti</label>
        <input type="text" id="src_container" name="src_container" required />
      </div>

      <div class="form-group">
        <label for="dest_container">Kohdekontti</label>
        <input type="text" id="dest_container" name="dest_container" required />
      </div>

      <div class="form-group">
        <label for="file_format">Tiedostoformaatti</label>
        <select id="file_format" name="file_format" required>
          <option value="json">JSON</option>
          <option value="csv">CSV</option>
        </select>
      </div>

      <!-- ‚≠êÔ∏è Extra‚Äëcolumns‚Äëkentille luodaan oma div; t√§ytet√§√§n JS:ll√§ -->
      <fieldset>
        <legend>Lis√§sarakkeet</legend>
        <div id="extraColumnsContainer"></div>
        <button type="button" id="addExtraColumnBtn">+ Lis√§√§ sarake</button>
      </fieldset>

      <div class="form-group">
        <label for="exclude_columns">Pois perus¬≠sarakkeista</label>
        <input type="text" id="exclude_columns" name="exclude_columns" />
      </div>

      <button type="submit" class="submit-btn">Tallenna</button>
      <button type="button" id="cancelBtn" class="submit-btn" style="margin-top:8px;background:#777;">
        Peruuta
      </button>
    </form>
  </div>

  <!-- ===========================
       4. üîó Asiakasdata JSON‚Äëmuodossa
       ===========================-->
  <script id="customersData" type="application/json">
    {{ customers | tojson }}
  </script>

  <!-- ===========================
       5. üíª JavaScript
       ===========================-->
  <script>
  (function () {
    const customers = JSON.parse(
      document.getElementById("customersData").textContent
    );

    /* ---------- Elementtireferenssit ---------- */
    const listTitle   = document.getElementById("listTitle");
    const customerUl  = document.getElementById("customerList");
    const form        = document.getElementById("editForm");
    const formTitle   = document.getElementById("formTitle");
    const cancelBtn   = document.getElementById("cancelBtn");

    /* ---------- Lomakkeen kent√§t ---------- */
    const $ = id => form.querySelector("#" + id);
    const fields = {
      name: $("name"),
      konserni: $("konserni"),
      src_container: $("src_container"),
      dest_container: $("dest_container"),
      file_format: $("file_format"),
      exclude_columns: $("exclude_columns"),
      extraContainer: document.getElementById("extraColumnsContainer")
    };

    /* ---------- Sarake‚Äëtemplate ---------- */
    function makeExtraRow(key = "", info = {name:"",dtype:""}) {
      const div = document.createElement("div");
      div.className = "extra-columns-group";
      div.innerHTML = `
        <button type="button" class="removeColumnBtn">Poista</button>
        <div class="form-group"><label>Avaimen nimi</label>
          <input type="text" name="extra_key" value="${key}">
        </div>
        <div class="form-group"><label>N√§ytt√∂nimi</label>
          <input type="text" name="extra_name" value="${info.name}">
        </div>
        <div class="form-group"><label>Tietotyyppi</label>
          <select name="extra_dtype" id="extra_dtype">
            <option value="string">String</option>
            <option value="float">Float</option>
          </select>
        </div>`;
      div.querySelector(".removeColumnBtn").onclick = () => div.remove();
      // Asetetaan valittu dtype
      const dtypeSelect = div.querySelector("select[name='extra_dtype']");
      dtypeSelect.value = info.dtype || "string"; // Oletus "string"
      return div;
    }
    document
      .getElementById("addExtraColumnBtn")
      .addEventListener("click", () =>
        fields.extraContainer.appendChild(makeExtraRow())
      );

    /* ---------- N√§yt√§ muokkauslomake ---------- */
    customerUl.addEventListener("click", e => {
      const btn = e.target.closest(".edit-btn");
      if (!btn) return;

      const name = btn.dataset.name;
      const cust = customers.find(c => c.name === name);
      if (!cust) return console.error("Asiakasta ei l√∂ytynyt");

      // T√§ytet√§√§n lomake
      formTitle.textContent = `Muokkaa: ${cust.name.toUpperCase()}`;
      fields.name.value            = cust.name;
      fields.konserni.value        = cust.konserni.join(",");
      fields.src_container.value   = (cust.source_container || "").replace("/", "");
      fields.dest_container.value  = (cust.destination_container || "").replace("/", "");
      fields.file_format.value     = cust.file_format;
      fields.exclude_columns.value = (cust.exclude_columns || []).join(",");

      // Tyhjenn√§ & t√§yt√§ lis√§sarakkeet
      fields.extraContainer.innerHTML = "";
      if (cust.extra_columns) {
        for (const [k, info] of Object.entries(cust.extra_columns)) {
          fields.extraContainer.appendChild(makeExtraRow(k, info));
        }
      }

      // Vaihda n√§kym√§
      customerUl.hidden = true;
      listTitle.hidden  = true;
      form.hidden       = false;
      form.scrollIntoView({behavior:"smooth"});
    });

    /* ---------- Peruutus ---------- */
    cancelBtn.onclick = () => {
      form.hidden       = true;
      customerUl.hidden = false;
      listTitle.hidden  = false;
    };
  })();
  </script>
</body>
</html>